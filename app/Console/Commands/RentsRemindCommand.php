<?php

namespace App\Console\Commands;

use App\Mail\RentCmmandMail;
use App\Mail\RentEndedMail;
use App\Mail\SuperAdminNotificationMail;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Mail;
use App\Models\Rent;
use Carbon\Carbon;
use App\Services\WhatsAppService;
use App\Models\CompanyWhatsappSetting;
use Illuminate\Support\Facades\Log;

class RentsRemindCommand extends Command
{
    protected $signature = 'rents:remind';
    protected $description = 'Send daily email and WhatsApp reminders for rents 5 days before the next due date and notify on rent end date.';

    public function handle()
    {
        Log::info('Rents Reminder Command: Starting execution.');
        $today = Carbon::today();

        // ุฃููุงู: ูุนุงูุฌุฉ ุงูุนููุฏ ุงูุชู ุงูุชูุช ุงูููู
        $this->processEndedRents($today);

        // ุซุงููุงู: ูุนุงูุฌุฉ ุงูุชุฐููุฑุงุช ููุนููุฏ ุงููุณุชุญูุฉ ูุฑูุจุงู
        $this->processDueRents($today);

        Log::info('Rents Reminder Command: Execution finished.');
        return 0;
    }

    /**
     * ุฌูุจ ุงูุนููุฏ ุงูุชู ุงูุชูุช ุงููููุ ุฅุฑุณุงู ุฅุดุนุงุฑุงุชุ ูุชุนุทูููุง
     */
    private function processEndedRents(Carbon $today)
    {
        $endedRents = Rent::with('customer.company.users')
            ->where('flag', 1)
            ->whereDate('end_date', $today)
            ->get();

        if ($endedRents->isEmpty()) {
            Log::info('No rents ended today.');
            return;
        }

        $this->info("Found " . $endedRents->count() . " rents that ended today.");

        foreach ($endedRents as $rent) {
            $customer = $rent->customer;
            if (!$customer) {
                Log::warning("Skipping ended rent {$rent->id}: Customer not found.");
                continue;
            }

            $this->info("Processing ended rent #{$rent->id} for customer: {$customer->name}");

            // ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุงูุงูุชูุงุก ููุนููู ูุงููุฏูุฑ
            $this->sendRentEndedNotifications($rent, $customer);

            // ุชุนุทูู ุงูุนูุฏ ูููุน ุฅุฑุณุงู ุชุฐููุฑุงุช ูุณุชูุจููุฉ
            $rent->update(['flag' => 0]);
            Log::info("Deactivated rent #{$rent->id} as its end date has been reached.");
        }
    }

    /**
     * ุฌูุจ ุงูุนููุฏ ุงููุณุชุญูุฉ ุฎูุงู 5 ุฃูุงูุ ูุฅุฑุณุงู ุชุฐููุฑุงุช
     */
    private function processDueRents(Carbon $today)
    {
        $reminderLimitDate = $today->copy()->addDays(5);

        $dueRents = Rent::with('customer.company.users')
            ->where('flag', 1)
            ->whereColumn('paid_amount', '<', 'monthly_rent')
            ->whereNotNull('next_rent_date')
            ->whereBetween('next_rent_date', [$today, $reminderLimitDate])
            ->get();

        if ($dueRents->isEmpty()) {
            Log::info("No rents due for reminders in the next 5 days.");
            return;
        }

        $this->info("Found " . $dueRents->count() . " rents due for reminders.");

        foreach ($dueRents as $rent) {
            $customer = $rent->customer;
            if (!$customer) {
                Log::warning("Skipping due rent {$rent->id}: Customer not found.");
                continue;
            }

            $dueDate = Carbon::parse($rent->next_rent_date);
            $daysLeft = $today->diffInDays($dueDate, false);
            $remainingAmount = $rent->monthly_rent - $rent->paid_amount;

            $this->info("Processing due rent #{$rent->id} for customer: {$customer->name}. Due in {$daysLeft} days.");

            // ุฅุฑุณุงู ุชุฐููุฑุงุช ุงูุฏูุน ููุนููู ูุงููุฏูุฑ
            $this->sendRentDueNotifications($rent, $customer, $remainingAmount, $dueDate, $daysLeft);
        }
    }

    /**
     * ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุงูุชูุงุก ุงูุนูุฏ
     */
    private function sendRentEndedNotifications(Rent $rent, $customer)
    {
        // ุฅุฑุณุงู ุฅูููู ููุนููู
        if ($customer->email) {
            try {
                Mail::to($customer->email)->send(new RentEndedMail($rent));
                $this->info("โ Sent RENT ENDED email to CUSTOMER: {$customer->email}");
                Log::info("Sent rent ended email to customer {$customer->email} for rent {$rent->id}");
            } catch (\Exception $e) {
                $this->error("โ Failed to send RENT ENDED email to customer {$customer->email}: " . $e->getMessage());
                Log::error("Failed to send rent ended email to customer {$customer->email}: " . $e->getMessage());
            }
        }

        // ุฅุฑุณุงู ูุงุชุณุงุจ ููุนููู
        if ($customer->phone) {
            $this->sendWhatsAppMessage($customer, 'rent_ended', ['rent' => $rent]);
        }

        // ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูููุฏุฑุงุก
        $this->notifySuperAdmins($rent, $customer, 'rent_ended');
    }

    /**
     * ุฅุฑุณุงู ุชุฐููุฑุงุช ุงูุฏูุน
     */
    private function sendRentDueNotifications(Rent $rent, $customer, $remainingAmount, Carbon $dueDate, int $daysLeft)
    {
        // ุฅุฑุณุงู ุฅูููู ููุนููู
        if ($customer->email) {
            try {
                Mail::to($customer->email)->send(new RentCmmandMail($rent, $remainingAmount, $dueDate));
                $this->info("โ Sent RENT DUE email to CUSTOMER: {$customer->email}");
                Log::info("Sent rent due email to customer {$customer->email} for rent {$rent->id}");
            } catch (\Exception $e) {
                $this->error("โ Failed to send RENT DUE email to customer {$customer->email}: " . $e->getMessage());
                Log::error("Failed to send rent due email to customer {$customer->email}: " . $e->getMessage());
            }
        }

        // ุฅุฑุณุงู ูุงุชุณุงุจ ููุนููู
        if ($customer->phone) {
            $this->sendWhatsAppMessage($customer, 'rent_due', [
                'rent' => $rent,
                'remainingAmount' => $remainingAmount,
                'dueDate' => $dueDate
            ]);
        }

        // ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูููุฏุฑุงุก
        $this->notifySuperAdmins($rent, $customer, 'rent_due', $daysLeft);
    }

    /**
     * ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ููุฏุฑุงุก ุงูุดุฑูุฉ
     */
    protected function notifySuperAdmins(Rent $rent, $customer, string $notificationType, int $daysLeft = null)
    {
        $company = $customer->company;
        if (!$company) {
            Log::warning("No company found for rent {$rent->id} to notify superadmins.");
            return;
        }

        $superAdmins = $company->users()->where('role', 'superadmin')->get();
        if ($superAdmins->isEmpty()) {
            Log::warning("No superadmins found for company {$company->id}.");
            return;
        }

        foreach ($superAdmins as $superAdmin) {
            // ุฅุฑุณุงู ุฅูููู ูููุฏูุฑ
            if ($superAdmin->email) {
                try {
                    Mail::to($superAdmin->email)->send(new SuperAdminNotificationMail($rent, $customer, $notificationType, $daysLeft));
                    $this->info("โ Sent super admin email to: {$superAdmin->email}");
                    Log::info("Sent super admin notification email to {$superAdmin->email} for rent {$rent->id}");
                } catch (\Exception $e) {
                    $this->error("โ Failed to send super admin email to {$superAdmin->email}: " . $e->getMessage());
                    Log::error("Failed to send super admin email to {$superAdmin->email}: " . $e->getMessage());
                }
            }
        }

        // ุฅุฑุณุงู ูุงุชุณุงุจ ูุฑูู ุงูุดุฑูุฉ
        if ($company->phone) {
            $this->sendWhatsAppMessage($company, "superadmin_{$notificationType}", [
                'rent' => $rent,
                'customer' => $customer,
                'daysLeft' => $daysLeft
            ], true);
        }
    }

    /**
     * ุฅุฑุณุงู ุฑุณุงุฆู ูุงุชุณุงุจ
     */
    private function sendWhatsAppMessage($recipient, string $type, array $data, bool $isCompany = false)
    {
        $companyId = $isCompany ? $recipient->id : $recipient->company_id;
        $phone = $recipient->phone;

        $whatsappSettings = CompanyWhatsappSetting::where('company_id', $companyId)->where('is_connected', true)->first();
        if (!$whatsappSettings) {
            Log::warning("WhatsApp is not connected for company #{$companyId}. Skipping message.");
            return;
        }

        try {
            $whatsappService = new WhatsAppService($companyId);
            $cleanPhone = $this->cleanPhoneNumber($phone);
            $message = $this->formatWhatsAppMessage($type, $data);
            $whatsappService->sendMessage($cleanPhone, $message);
            $this->info("โ Sent WhatsApp '{$type}' to: {$cleanPhone}");
            Log::info("Sent WhatsApp '{$type}' to {$cleanPhone} for company #{$companyId}");
        } catch (\Exception $e) {
            $this->error("โ Failed to send WhatsApp to {$phone}: " . $e->getMessage());
            Log::error("Failed to send WhatsApp to {$phone} for company #{$companyId}: " . $e->getMessage());
        }
    }

    /**
     * ุชูุณูู ุฑุณุงุฆู ุงููุงุชุณุงุจ
     */
    private function formatWhatsAppMessage(string $type, array $data): string
    {
        $rent = $data['rent'];
        $customer = $data['customer'] ?? $rent->customer;
        $companyName = $customer->company->company_name ?? 'ุดุฑูุชู';

        switch ($type) {
            case 'rent_due':
                $dueDateFormatted = $data['dueDate']->format('Y-m-d');
                return "โฐ ุชุฐููุฑ ุจุฏูุน ุงูุฅูุฌุงุฑ

" .
                       "ุนุฒูุฒู/ุนุฒูุฒุชู {$customer->name},

" .
                       "ููุฏ ุชุฐููุฑูู ุจุฃู ุงูุฅูุฌุงุฑ ูุณุชุญู ููุฏูุน.
" .
                       "๐ ุชุงุฑูุฎ ุงูุงุณุชุญูุงู: {$dueDateFormatted}
" .
                       "๐ฐ ุงููุจูุบ ุงููุชุจูู: {$data['remainingAmount']} ุฌููู

" .
                       "ูุฑุฌู ุชุณุฏูุฏ ุงููุจูุบ ูู ุฃูุฑุจ ููุช ูููู.
" .
                       "{$companyName}";

            case 'rent_ended':
                return "๐ ุงูุชูุงุก ุนูุฏ ุงูุฅูุฌุงุฑ

" .
                       "ุนุฒูุฒู/ุนุฒูุฒุชู {$customer->name},

" .
                       "ููุฏ ุฅุนูุงููู ุจุฃู ุนูุฏ ุงูุฅูุฌุงุฑ ุงูุฎุงุต ุจูู ูุฏ ุงูุชูู ุงูููู.
" .
                       "๐ฐ ุงููุจูุบ ุงููุชุจูู ุฅู ูุฌุฏ: " . ($rent->monthly_rent - $rent->paid_amount) . " ุฌููู

" .
                       "ุดูุฑุงู ูุซูุชูู ุจูุง.
" .
                       "{$companyName}";

            case 'superadmin_rent_due':
                return "๐ ุชูุจูู ูููุฏูุฑ - ุฅูุฌุงุฑ ูุณุชุญู

" .
                       "ุงูุนููู: {$customer->name}
" .
                       "ูุชุจูู ููุงุณุชุญูุงู: {$data['daysLeft']} ููู/ุฃูุงู
" .
                       "ุงููุจูุบ ุงููุชุจูู: " . ($rent->monthly_rent - $rent->paid_amount) . " ุฌููู

" .
                       "ูุฑุฌู ุงููุชุงุจุนุฉ.";

            case 'superadmin_rent_ended':
                return "๐ ุฅุดุนุงุฑ ูููุฏูุฑ - ุงูุชูุงุก ุนูุฏ

" .
                       "ุงูุชูู ุนูุฏ ุงูุฅูุฌุงุฑ ุงูููู ููุนููู:
" .
                       "ุงูุนููู: {$customer->name}
" .
                       "ุงููุจูุบ ุงููุชุจูู ุฅู ูุฌุฏ: " . ($rent->monthly_rent - $rent->paid_amount) . " ุฌููู";

            default:
                return '';
        }
    }

    /**
     * ุชูุธูู ุฑูู ุงููุงุชู ูุฅุถุงูุฉ ููุฏ ุงูุฏููุฉ
     */
    protected function cleanPhoneNumber($phone): string
    {
        $phone = preg_replace('/[^0-9]/', '', $phone);
        if (empty($phone)) {
            throw new \Exception('ุฑูู ุงููุงุชู ูุงุฑุบ ุฃู ุบูุฑ ุตุงูุญ.');
        }
        if (substr($phone, 0, 2) === '20') {
            return $phone;
        }
        if (substr($phone, 0, 1) === '0') {
            return '20' . substr($phone, 1);
        }
        return '20' . $phone;
    }
}
